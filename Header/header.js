// Translation dictionary — YOUR ORIGINAL — 100% UNCHANGED
const translations = {
  english: {
    enterPinCode: "Select Pincode:",
    about: "About Us",
    chevron: "Down Arrow",
    contact: "Contact Us",
    wishlist: "Wishlist",
    cart: "Cart",
    profile: "Account",
    signupLogin: "Sign Up / Login",
    orders: "Orders",
    logout: "Logout",
    motherCare: "Mother Care",
    babyCare: "Baby Care",
    medicineHealthcare: "Medicine & HealthCare",
    prescriptionMedicines: "Prescription Medicines (Upload Prescription)",
    otc: "Over-the-Counter (OTC) Medicines",
    chronic: "Chronic Care (Diabetes, Hypertension, Cardiac, Asthma, Thyroid)",
    firstAid: "First Aid & Emergency" ,
    pain: "Pain Relief & Fever",
    allergy: "Allergy & Cold Care",
    digestive: "Digestive Health",
    men: "Men's Health",
    wellness: "Wellness",
    vitamins: "Vitamins & Supplements",
    skin: "Skin & Hair Care",
    oral: "Oral Care",
    menstrual: "Menstrual & Intimate Care",
    fitness: "Fitness & Weight Management",
    senior: "Senior Care",
    immunity: "Immunity Boosters",
    ayurveda: "Ayurveda & Herbal Products",
    devices: "Devices",
    bp: "Monitoring Devices (BP Monitors, Glucometers)",
    mobility: "Mobility Aids (Walkers, Wheelchairs)",
    respiratory: "Respiratory Care (Nebulizers, Oxygen)",
    surgical: "Surgical Items",
    dressing: "Dressings and Bandages",
    consumable: "Surgical Consumables",
    IV: "IV and Infusion Items",
    catheters: "Catheters and Tubes",
    wound: "Wound Care",
    orthopedic: "Orthopedic Support",
    injectables: "IV Fluids and Injectables",
    kits: "Surgical Kits",
    pincodeSuccess: "Pin Code selected:",
    invalidPincode: "Please enter a valid 6-digit pin code.",
    delivering: "Delivering to %location% in 3-5 days"
  },
  hindi: {
    enterPinCode: "पिनकोड चुनें",
    about: "हमारे बारे में",
    chevron: "Down Arrow",
    go: "जाएं",
    contact: "संपर्क",
    wishlist: "इच्छा सूची",
    cart: "कार्ट",
    profile: "प्रोफ़ाइल",
    signupLogin: "साइन अप / लॉगिन",
    orders: "ऑर्डर",
    logout: "लॉगआउट",
    motherCare: "मदर केयर",
    babyCare: "बेबी केअर",
    medicineHealthcare: "दवाइयाँ और स्वास्थ्य देखभाल",
    prescriptionMedicines: "प्रिस्क्रिप्शन दवाइयाँ (प्रिस्क्रिप्शन अपलोड करें)",
    otc: "ओवर-द-काउंटर (OTC) दवाइयाँ",
    chronic: "क्रॉनिक केयर (मधुमेह, उच्च रक्तचाप, हृदय, अस्थमा, थायराइड)",
    firstAid: "प्राथमिक चिकित्सा और आपातकाल",
    pain: "दर्द निवारक और बुखार",
    allergy: "एलर्जी और सर्दी की देखभाल",
    digestive: "पाचन स्वास्थ्य",
    men: "पुरुष स्वास्थ्य",
    wellness: "वेलनेस",
    vitamins: "विटामिन और सप्लीमेंट्स",
    skin: "त्वचा और बाल देखभाल",
    oral: "मौखिक देखभाल",
    menstrual: "मासिक धर्म और अंतरंग देखभाल",
    fitness: "फिटनेस और वजन प्रबंधन",
    senior: "वरिष्ठ नागरिक देखभाल",
    immunity: "प्रतिरक्षा बूस्टर",
    ayurveda: "आयुर्वेद और हर्बल उत्पाद",
    devices: "डिवाइस",
    bp: "मॉनिटरिंग डिवाइस (BP मॉनिटर, ग्लूकोमीटर)",
    mobility: "गतिशीलता सहायता (वॉकर, व्हीलचेयर)",
    respiratory: "श्वसन देखभाल (नेबुलाइज़र, ऑक्सीजन)",
    surgical: "सर्जिकल आइटम",
    dressing: "ड्रेसिंग और पट्टियाँ",
    consumable: "शल्य चिकित्सा उपभोग्य सामग्री",
    IV: "आईवी और इन्फ्यूजन आइटम",
    catheters: "कैथेटर और ट्यूब",
    wound: "घाव की देखभाल",
    orthopedic: "ऑर्थोपेडिक सपोर्ट",
    injectables: "आईवी तरल पदार्थ और इंजेक्शन",
    kits: "सर्जिकल किट",
    dressing: "ड्रेसिंग और पट्टियाँ",
    pincodeSuccess: "पिन कोड चुना गया:",
    invalidPincode: "कृपया 6 अंकों का वैध भारतीय पिनकोड डालें।",
    delivering: "%location% में 3-5 दिनों में डिलीवरी"
  },
  marathi: {
    enterPinCode: "पिनकोड निवडा",
    go: "जा",
    about: "आमच्याबद्दल",
    chevron: "Down Arrow",
    contact: "संपर्क",
    wishlist: "इच्छा यादी",
    cart: "कार्ट",
    profile: "प्रोफाइल",
    signupLogin: "साइन अप / लॉगिन",
    orders: "ऑर्डर",
    logout: "लॉगआउट",
    motherCare: "मदर केअर",
    babyCare: "बाळ काळजी",
    medicineHealthcare: "औषधे आणि आरोग्यसेवा",
    prescriptionMedicines: "प्रिस्क्रिप्शन औषधे (प्रिस्क्रिप्शन अपलोड करा)",
    otc: "ओव्हर-द-काउंटर (OTC) औषधे",
    chronic: "दीर्घकालीन काळजी (मधुमेह, उच्च रक्तदाब, हृदय, अस्थमा, थायरॉईड)",
    firstAid: "प्रथमोपचार आणि आपत्कालीन",
    pain: "वेदना आराम आणि ताप",
    allergy: "एलर्जी आणि सर्दी काळजी",
    digestive: "पचन आरोग्य",
    men: "पुरुष आरोग्य",
    wellness: "वेलनेस",
    vitamins: "व्हिटॅमिन आणि सप्लिमेंट्स",
    skin: "त्वचा आणि केस काळजी",
    oral: "तोंडाची काळजी",
    menstrual: "मासिक पाळी आणि अंतरंग काळजी",
    fitness: "फिटनेस आणि वजन व्यवस्थापन",
    senior: "ज्येष्ठ नागरिक काळजी",
    immunity: "रोगप्रतिकार शक्ती वाढवणारे",
    ayurveda: "आयुर्वेद",
    devices: "उपकरणे",
    bp: "मॉनिटरिंग उपकरणे (BP मॉनिटर, ग्लूकोमीटर)",
    mobility: "गतिशीलता सहाय्य (वॉकर, व्हीलचेअर)",
    respiratory: "श्वसन काळजी (नेब्युलायझर, ऑक्सिजन)",
    surgical: "सर्जिकल वस्तू",
    dressing: "पट्ट्या आणि पट्टे",
    consumable: "शस्त्रक्रिया वापरलेली साहित्य",
    IV: "आयव्ही आणि इन्फ्यूजन वस्तू",
    catheters: "कॅथेटर आणि नळ्या",
    wound: "जखमेची काळजी",
    orthopedic: "अस्थिसंध समर्थन",
    injectables:"आयव्ही द्रव आणि इंजेक्शन",
    kits: "शस्त्रक्रिया किट",
    pincodeSuccess: "पिन कोड निवडला:",
    invalidPincode: "कृपया वैध 6 अंकी पिन कोड प्रविष्ट करा।",
    delivering: "%location% ला 3-5 दिवसांत डिलिव्हरी"
  }
};

// YOUR EXACT ORIGINAL FUNCTIONS — NOT A SINGLE CHARACTER CHANGED
async function selectPin() {
  console.log('selectPin function called');
  const pincodeInput = document.getElementById('pincode');
  if (!pincodeInput) {
    console.error('Pincode input element not found!');
    return;
  }
  const pin = pincodeInput.value.trim();
  console.log('Pin value:', pin);
  const language = localStorage.getItem('selectedLanguage') || 'english';
  const t = translations[language];
  if (!/^\d{6}$/.test(pin)) {
    showNotification(t.invalidPincode);
    return;
  }
  try {
    const response = await fetch(`https://api.postalpincode.in/pincode/${pin}`);
    const data = await response.json();
    if (data[0].Status === 'Success') {
      const po = data[0].PostOffice[0];
      const location = `${po.District}, ${po.State}`;
      localStorage.setItem('savedPincode', pin);
      localStorage.setItem('savedLocation', location);
      const userId = sessionStorage.getItem('userId');
      if (userId) {
        const updatePayload = {
          addressPincode: pin,
          addressCity: po.District,
          addressState: po.State
        };
        fetch(`http://localhost:8083/api/users/patch-user-by-id/${userId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatePayload)
        })
          .then(() => console.log('Pincode saved to backend'))
          .catch(err => console.warn('Failed to sync pincode to backend', err));
      }
      const deliverySpan = document.querySelector('#delivery-info span');
      deliverySpan.textContent = t.delivering.replace('%location%', location);
      document.getElementById('delivery-info').classList.remove('hidden');
      showNotification(`${t.pincodeSuccess} ${pin}`);
    } else {
      showNotification(t.invalidPincode);
    }
  } catch (e) {
    showNotification(t.invalidPincode);
  }
}

async function loadSavedPincode() {
  console.log('loadSavedPincode function called');
  const pincodeInput = document.getElementById('pincode');
  if (!pincodeInput) return;
  const userId = sessionStorage.getItem('userId');
  if (userId) {
    try {
      const res = await fetch(`http://localhost:8083/api/users/get-by-user-id/${userId}`);
      if (res.ok) {
        const user = await res.json();
        const pin = user.addressPincode?.trim();
        const city = user.addressCity?.trim();
        const state = user.addressState?.trim() || 'Maharashtra';
        if (pin && pin.length === 6) {
          const location = `${city || 'Your City'}, ${state}`;
          localStorage.setItem('savedPincode', pin);
          localStorage.setItem('savedLocation', location);
          pincodeInput.value = pin;
          const language = localStorage.getItem('selectedLanguage') || 'english';
          const t = translations[language];
          const deliverySpan = document.querySelector('#delivery-info span');
          if (deliverySpan) {
            deliverySpan.textContent = t.delivering.replace('%location%', location);
            document.getElementById('delivery-info').classList.remove('hidden');
          }
          console.log('Pincode loaded from backend:', pin, location);
          return;
        }
      }
    } catch (err) {
      console.warn('Backend pincode fetch failed, falling back to localStorage', err);
    }
  }
  const savedPincode = localStorage.getItem('savedPincode');
  const savedLocation = localStorage.getItem('savedLocation');
  if (savedPincode && savedLocation) {
    pincodeInput.value = savedPincode;
    const language = localStorage.getItem('selectedLanguage') || 'english';
    const t = translations[language];
    const deliverySpan = document.querySelector('#delivery-info span');
    if (deliverySpan) {
      deliverySpan.textContent = t.delivering.replace('%location%', savedLocation);
      document.getElementById('delivery-info').classList.remove('hidden');
    }
  }
}

function translatePage(language) {
  const elements = document.querySelectorAll('[data-i18n]');
  elements.forEach(element => {
    const key = element.getAttribute('data-i18n');
    if (translations[language] && translations[language][key]) {
      element.textContent = translations[language][key];
    }
  });
  const placeholderElements = document.querySelectorAll('[data-i18n-placeholder]');
  placeholderElements.forEach(element => {
    const key = element.getAttribute('data-i18n-placeholder');
    if (translations[language] && translations[language][key]) {
      element.placeholder = translations[language][key];
    }
  });
  localStorage.setItem('selectedLanguage', language);
  console.log(`Language changed to: ${language}`);
}

function changeLanguage(lang) {
  translatePage(lang);
  showNotification(`Language changed to ${lang}`);
}

function showNotification(message) {
  const existingNotification = document.querySelector('.custom-notification');
  if (existingNotification) {
    existingNotification.remove();
  }
  const notification = document.createElement('div');
  notification.className = 'custom-notification';
  notification.textContent = message;
  notification.style.cssText = `
    position: fixed;
    top: 80px;
    right: 20px;
    background: #4CAF50;
    color: white;
    padding: 15px 20px;
    border-radius: 5px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    z-index: 10000;
    animation: slideIn 0.3s ease;
  `;
  document.body.appendChild(notification);
  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

const style = document.createElement('style');
style.textContent = `
  @keyframes slideIn {
    from { transform: translateX(400px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  @keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(400px); opacity: 0; }
  }
`;
document.head.appendChild(style);

function toggleProfileDropdown() {
  const profileMenu = document.getElementById('profile-menu');
  if (profileMenu) {
    profileMenu.classList.toggle('show');
    console.log('Profile menu toggled');
  }
}

function initializeHeader() {
  console.log('Initializing header...');
  const savedLanguage = localStorage.getItem('selectedLanguage') || 'english';
  console.log('Saved language:', savedLanguage);
  const languageSelector = document.getElementById('language-selector');
  if (languageSelector) {
    languageSelector.value = savedLanguage;
    translatePage(savedLanguage);
    languageSelector.addEventListener('change', function() {
      changeLanguage(this.value);
    });
  }
  loadSavedPincode();
  const pincodeInput = document.getElementById('pincode');
  if (pincodeInput) {
    pincodeInput.addEventListener('keypress', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        selectPin();
      }
    });
  }
  const clearBtn = document.getElementById('pincode-clear');
  if (pincodeInput && clearBtn) {
    if (pincodeInput.value) {
      clearBtn.classList.remove('hidden');
    }
    pincodeInput.addEventListener('input', () => {
      clearBtn.classList.toggle('hidden', !pincodeInput.value);
    });
    clearBtn.addEventListener('click', () => {
      pincodeInput.value = '';
      clearBtn.classList.add('hidden');
      document.getElementById('delivery-info').classList.add('hidden');
      localStorage.removeItem('savedPincode');
      localStorage.removeItem('savedLocation');
    });
  }
  const profileBtn = document.getElementById('profile-btn');
  if (profileBtn) {
    profileBtn.addEventListener('click', function(event) {
      event.stopPropagation();
      toggleProfileDropdown();
      console.log('Profile button clicked');
    });
  }
  document.getElementById('logout-btn')?.addEventListener('click', function(e) {
    e.preventDefault();
    if (confirm("Are you sure you want to logout?")) {
      sessionStorage.clear();
      localStorage.clear();
      alert("Logged out successfully!");
      window.location.href = "/index.html";
    }
  });
  document.querySelector('#mobile-profile-menu a.text-red-600')?.addEventListener('click', function(e) {
    e.preventDefault();
    if (confirm("Are you sure you want to logout?")) {
      sessionStorage.clear();
      localStorage.clear();
      alert("Logged out successfully!");
      window.location.href = "/index.html";
    }
  });
  console.log('Header initialization complete');
}

document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM fully loaded, initializing header...');
  initializeHeader();
});

if (document.readyState === 'interactive' || document.readyState === 'complete') {
  console.log('DOM already ready, initializing header...');
  setTimeout(initializeHeader, 0);
}

document.getElementById('profile-btn')?.addEventListener('click', function(e) {
  e.stopPropagation();
  const menu = document.getElementById('profile-menu');
  const isHidden = menu.classList.contains('hidden');
  if (isHidden) {
    menu.classList.remove('hidden');
    setTimeout(() => menu.classList.remove('opacity-0'), 10);
  } else {
    menu.classList.add('opacity-0');
    setTimeout(() => menu.classList.add('hidden'), 200);
  }
});

document.getElementById('mobile-profile-btn')?.addEventListener('click', (e) => {
  e.stopPropagation();
  document.getElementById('mobile-profile-menu').classList.toggle('hidden');
});

document.getElementById('mobile-menu-btn')?.addEventListener('click', (e) => {
  e.stopPropagation();
  document.getElementById('mobile-menu').classList.toggle('hidden');
});

function highlightActiveNav() {
  const path = window.location.pathname.split('?')[0].replace(/^\//, '');
  document.querySelectorAll('.nav-link, .mobile-nav-link').forEach(link => {
    link.classList.remove('active');
    const href = link.getAttribute('href');
    if (!href || href === '#' || href === 'javascript:void(0)') return;
    const cleanHref = href.split('?')[0].replace(/^\//, '');
    if (path === cleanHref || path.includes(cleanHref)) {
      link.classList.add('active');
    }
  });
}

document.addEventListener('DOMContentLoaded', highlightActiveNav);
highlightActiveNav();