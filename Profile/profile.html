<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Profile</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="../Header/header.css">
  <link rel="stylesheet" href="../Footer/footer.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#36C2CE',
            secondary: '#0ea5e9',
            accent: '#10b981',
            dark: '#1e293b',
          },
        },
      },
    };
  </script>
  <style>
    @media (max-width: 1024px) {
      #footer-placeholder {
        display: none !important;
      }
    }
  </style>
</head>
<body class="bg-cover bg-center bg-no-repeat min-h-screen flex flex-col"
      style="background-image: url('https://i.pinimg.com/736x/1e/e5/07/1ee5072a72ffa83aace4863dd6bd23cd.jpg');">

  <div id="header-placeholder"></div>

  <div class="flex-grow flex items-center justify-center py-10 mt-32">
    <div class="w-full max-w-6xl bg-white shadow-md rounded-lg flex flex-col md:flex-row overflow-hidden">

      <div class="w-full md:w-1/3 bg-primary/10 border-r border-primary p-6 flex flex-col items-center">
        <div class="w-24 h-24 bg-primary text-white rounded-full flex items-center justify-center text-5xl mb-4">
          <i class="fa-regular fa-user"></i>
        </div>
        <h2 class="text-xl font-bold text-dark mb-1" id="profileName">Loading...</h2>
        <p class="text-sm text-gray-600 mb-6">Member</p>

        <nav class="w-full">
          <button id="profileTab" class="w-full text-left flex items-center gap-2 px-4 py-2 rounded-lg bg-primary text-white mb-2">
            <i class="fa-solid fa-user"></i> Profile Information
          </button>
          <button id="addressTab" class="w-full text-left flex items-center gap-2 px-4 py-2 rounded-lg hover:bg-primary/20">
            <i class="fa-solid fa-location-dot"></i> Addresses
          </button>
        </nav>
      </div>

      <div class="w-full md:w-3/3 p-6">
        <div id="profileInfo">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-dark">Personal Information</h2>
            <button id="editBtn" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-secondary transition">
              Edit Profile
            </button>
          </div>

          <div class="flex items-center gap-4 mb-6">
            <div class="w-16 h-16 bg-primary/20 text-primary rounded-full flex items-center justify-center text-3xl font-bold">
              <i class="fa-regular fa-user"></i>
            </div>
            <div>
              <h3 class="text-lg font-semibold text-dark" id="displayName">Loading...</h3>
              <p class="text-sm text-gray-500">Member since 2024</p>
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium text-gray-700">First Name *</label>
              <input id="firstName" type="text" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2 focus:border-primary focus:ring-primary outline-none" disabled />
            </div>
            <div><label class="block text-sm font-medium text-gray-700">Last Name *</label>
              <input id="lastName" type="text" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2 focus:border-primary focus:ring-primary outline-none" disabled />
            </div>
            <div><label class="block text-sm font-medium text-gray-700">Phone Number *</label>
              <input id="phoneNumber" type="text" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2 focus:border-primary focus:ring-primary outline-none" disabled />
            </div>
            <div><label class="block text-sm font-medium text-gray-700">Email Address *</label>
              <input id="emailAddress" type="email" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2 focus:border-primary focus:ring-primary outline-none" disabled />
            </div>
            <div><label class="block text-sm font-medium text-gray-700">Account Status</label>
              <input id="accountStatus" type="text" value="Active" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2 focus:border-primary focus:ring-primary outline-none" disabled />
            </div>
          </div>

          <div class="mt-6">
            <button id="changePasswordBtn" class="bg-dark text-white px-4 py-2 rounded-md hover:bg-primary transition">
              Change Password
            </button>
            <button id="deleteAccountBtn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition ml-4">
              Delete Account
            </button>


          </div>
        </div>

        <div id="addressInfo" class="hidden">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-dark">Saved Addresses</h2>
            <button id="addAddressBtn" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-secondary transition">
              <i class="fa-solid fa-plus mr-2"></i> Add New Address
            </button>
          </div>
          <div id="addressList" class="space-y-4">
            <p class="text-gray-600" id="noAddressMsg">Loading addresses...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div id="passwordModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg w-11/12 max-w-md p-6">
      <h3 class="text-xl font-semibold text-dark mb-4">Change Password</h3>
      <label class="block text-sm font-medium text-gray-700 mb-1">New Password</label>
      <input type="password" id="newPass" class="w-full border border-gray-300 rounded-md px-3 py-2 mb-3 focus:border-primary outline-none">
      <label class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
      <input type="password" id="confirmPass" class="w-full border border-gray-300 rounded-md px-3 py-2 mb-5 focus:border-primary outline-none">
      <div class="flex justify-end gap-3">
        <button id="cancelPassBtn" class="bg-gray-300 text-dark px-4 py-2 rounded-md hover:bg-gray-400">Cancel</button>
        <button id="savePassBtn" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-secondary">Save</button>
      </div>
    </div>
  </div>

  <!-- Address Modal -->
  <div id="addressModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg w-11/12 max-w-lg p-6">
      <h3 class="text-xl font-semibold text-dark mb-4" id="addressModalTitle">Add New Address</h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div><label>First Name *</label><input id="addressFirstName" type="text" class="mt-1 w-full border rounded-md px-3 py-2" /></div>
        <div><label>Last Name *</label><input id="addressLastName" type="text" class="mt-1 w-full border rounded-md px-3 py-2" /></div>
        <div><label>Phone Number *</label><input id="addressPhone" type="text" class="mt-1 w-full border rounded-md px-3 py-2" /></div>
        <div><label>Email Address *</label><input id="addressEmail" type="email" class="mt-1 w-full border rounded-md px-3 py-2" /></div>
        <div class="col-span-2"><label>Address Landmark *</label><input id="addressLandmark" type="text" class="mt-1 w-full border rounded-md px-3 py-2" /></div>
        <div><label>Address Area *</label><input id="addressArea" type="text" class="mt-1 w-full border rounded-md px-3 py-2" /></div>
        <div><label>City *</label><input id="addressCity" type="text" class="mt-1 w-full border rounded-md px-3 py-2" /></div>
        <div><label>Pincode *</label><input id="addressPincode" type="text" class="mt-1 w-full border rounded-md px-3 py-2" /></div>
        <div><label>State *</label><input id="addressState" type="text" class="mt-1 w-full border rounded-md px-3 py-2" /></div>
        <div><label>Country *</label><input id="addressCountry" type="text" class="mt-1 w-full border rounded-md px-3 py-2" value="India" /></div>
        <div class="col-span-2">
          <label>Address Type *</label>
          <select id="addressType" class="mt-1 w-full border rounded-md px-3 py-2">
            <option value="HOME">HOME</option>
            <option value="WORK">WORK</option>
            <option value="OTHER">OTHER</option>
          </select>
        </div>
      </div>
      <div class="flex justify-end gap-3 mt-5">
        <button id="cancelAddressBtn" class="bg-gray-300 text-dark px-4 py-2 rounded-md hover:bg-gray-400">Cancel</button>
        <button id="saveAddressBtn" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-secondary">Save</button>
      </div>
    </div>
  </div>

  <div id="footer-placeholder"></div>

  <script>
    function loadHeader() {
      fetch('../Header/header.html')
        .then(r => r.ok ? r.text() : Promise.reject())
        .then(html => {
          document.getElementById('header-placeholder').innerHTML = html;
          const script = document.createElement('script');
          script.src = '../Header/header.js';
          document.body.appendChild(script);
        })
        .catch(() => {});
    }
    function loadFooter() {
      fetch('../Footer/footer.html')
        .then(r => r.ok ? r.text() : Promise.reject())
        .then(html => document.getElementById('footer-placeholder').innerHTML = html)
        .catch(() => {});
    }
    document.addEventListener('DOMContentLoaded', () => { loadHeader(); loadFooter(); });
  </script>

  <!-- FIXED JS - FULLY MATCHED WITH YOUR BACKEND (phone, not mobile) -->
  <script>
    const API_BASE_URL = 'http://localhost:8083/api/users';  // Change port if needed
    let currentUserId = null;
    let currentUserData = null;
    let isEditingProfile = false;

    document.addEventListener('DOMContentLoaded', function() {
      const storedUserId = sessionStorage.getItem('userId');
      if (!storedUserId) {
        alert('Please login first');
        window.location.href = '../index.html';
        return;
      }
      currentUserId = parseInt(storedUserId);
      loadUserData();
      setupEventListeners();
    });

    async function loadUserData() {
      try {
        const res = await fetch(`${API_BASE_URL}/get-by-user-id/${currentUserId}`);
        if (!res.ok) throw new Error('User not found');
        const user = await res.json();
        currentUserData = user;

        document.getElementById("profileName").textContent = `${user.firstName || ''} ${user.lastName || ''}`.trim() || 'User';
        document.getElementById("displayName").textContent = `${user.firstName || ''} ${user.lastName || ''}`.trim() || 'User';
        document.getElementById("firstName").value = user.firstName || '';
        document.getElementById("lastName").value = user.lastName || '';
        document.getElementById("phoneNumber").value = user.phone || '';
        document.getElementById("emailAddress").value = user.email || '';

        loadAddresses(user);
      } catch (err) {
        console.error(err);
        alert('Failed to load profile');
      }
    }

    function loadAddresses(user) {
      const list = document.getElementById("addressList");
      list.innerHTML = '';
      if (user.addressLandmark && user.addressLandmark.trim() !== '') {
        document.getElementById("noAddressMsg")?.classList.add("hidden");
        const div = document.createElement("div");
        div.className = "border border-gray-300 rounded-md p-4 flex justify-between items-start";
        div.innerHTML = `
          <div>
            <p class="font-semibold">${user.firstName} ${user.lastName}</p>
            <p class="text-gray-600">${user.addressLandmark}, ${user.addressArea}, ${user.addressCity} - ${user.addressPincode}</p>
            <p class="text-gray-600">Phone: ${user.phone}</p>
            <p class="text-gray-500">${user.addressType || 'HOME'} Address</p>
          </div>
          <div>
            <button onclick="editAddress()" class="bg-primary text-white px-3 py-1 rounded-md hover:bg-secondary mr-2">Edit</button>
            <button onclick="deleteAddress()" class="bg-red-600 text-white px-3 py-1 rounded-md hover:bg-red-700">Delete</button>
          </div>
        `;
        list.appendChild(div);
      } else {
        list.innerHTML = `<p class="text-gray-600">You currently have no saved addresses.</p>`;
      }
    }

   function setupEventListeners() {
      document.getElementById("profileTab").onclick = () => {
        document.getElementById("profileInfo").classList.remove("hidden");
        document.getElementById("addressInfo").classList.add("hidden");
        document.getElementById("profileTab").classList.add("bg-primary", "text-white");
        document.getElementById("addressTab").classList.remove("bg-primary", "text-white");
      };
      document.getElementById("addressTab").onclick = () => {
        document.getElementById("addressInfo").classList.remove("hidden");
        document.getElementById("profileInfo").classList.add("hidden");
        document.getElementById("addressTab").classList.add("bg-primary", "text-white");
        document.getElementById("profileTab").classList.remove("bg-primary", "text-white");
      };
      document.getElementById("editBtn").onclick = toggleEditProfile;
      document.getElementById("changePasswordBtn").onclick = () => document.getElementById("passwordModal").classList.remove("hidden");
      document.getElementById("cancelPassBtn").onclick = () => document.getElementById("passwordModal").classList.add("hidden");
      document.getElementById("savePassBtn").onclick = handlePasswordChange;
      document.getElementById("addAddressBtn").onclick = () => openAddressModal();
      document.getElementById("cancelAddressBtn").onclick = () => document.getElementById("addressModal").classList.add("hidden");
      document.getElementById("saveAddressBtn").onclick = handleSaveAddress;
      document.getElementById("deleteAccountBtn").onclick = handleDeleteAccount;

      // LOGOUT BUTTON â€” WORKS PERFECTLY
      document.getElementById("logoutBtn").onclick = function() {
        if (confirm("Are you sure you want to logout?")) {
          sessionStorage.clear();
          localStorage.removeItem('savedPincode');
          localStorage.removeItem('savedLocation');
          alert("Logged out successfully!");
          window.location.href = "/index.html";
        }
      };
    }

    function toggleEditProfile() {
      isEditingProfile = !isEditingProfile;
      const inputs = document.querySelectorAll("#profileInfo input:not([id='accountStatus'])");
      inputs.forEach(i => i.disabled = !isEditingProfile);
      document.getElementById("editBtn").textContent = isEditingProfile ? "Save Profile" : "Edit Profile";
      if (!isEditingProfile) saveProfileChanges();
    }

    async function saveProfileChanges() {
      const data = {
        firstName: document.getElementById("firstName").value.trim(),
        lastName: document.getElementById("lastName").value.trim(),
        email: document.getElementById("emailAddress").value.trim(),
        phone: document.getElementById("phoneNumber").value.trim()
      };
      try {
        await fetch(`${API_BASE_URL}/patch-user-by-id/${currentUserId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        loadUserData();
        alert("Profile updated successfully!");
      } catch (err) {
        alert("Update failed");
      }
    }

    async function handlePasswordChange() {
      const newP = document.getElementById("newPass").value;
      const confP = document.getElementById("confirmPass").value;
      if (newP !== confP) return alert("Passwords don't match");
      if (newP.length < 6) return alert("Password too short");

      try {
        await fetch(`${API_BASE_URL}/patch-user-by-id/${currentUserId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: newP })
        });
        alert("Password changed successfully!");
        document.getElementById("passwordModal").classList.add("hidden");
        document.getElementById("newPass").value = '';
        document.getElementById("confirmPass").value = '';
      } catch (err) {
        alert("Password change failed");
      }
    }

    function openAddressModal() {
      document.getElementById("addressModalTitle").textContent = currentUserData.addressLandmark ? "Edit Address" : "Add New Address";
      document.getElementById("addressFirstName").value = currentUserData.firstName || '';
      document.getElementById("addressLastName").value = currentUserData.lastName || '';
      document.getElementById("addressEmail").value = currentUserData.email || '';
      document.getElementById("addressPhone").value = currentUserData.phone || '';
      document.getElementById("addressLandmark").value = currentUserData.addressLandmark || '';
      document.getElementById("addressArea").value = currentUserData.addressArea || '';
      document.getElementById("addressCity").value = currentUserData.addressCity || '';
      document.getElementById("addressPincode").value = currentUserData.addressPincode || '';
      document.getElementById("addressState").value = currentUserData.addressState || '';
      document.getElementById("addressCountry").value = currentUserData.addressCountry || 'India';
      document.getElementById("addressType").value = currentUserData.addressType || 'HOME';
      document.getElementById("addressModal").classList.remove("hidden");
    }

    window.editAddress = openAddressModal;

    async function handleSaveAddress() {
      const data = {
        firstName: document.getElementById("addressFirstName").value.trim(),
        lastName: document.getElementById("addressLastName").value.trim(),
        email: document.getElementById("addressEmail").value.trim(),
        phone: document.getElementById("addressPhone").value.trim(),
        addressLandmark: document.getElementById("addressLandmark").value.trim(),
        addressArea: document.getElementById("addressArea").value.trim(),
        addressCity: document.getElementById("addressCity").value.trim(),
        addressPincode: document.getElementById("addressPincode").value.trim(),
        addressState: document.getElementById("addressState").value.trim(),
        addressCountry: document.getElementById("addressCountry").value.trim(),
        addressType: document.getElementById("addressType").value
      };

      try {
        await fetch(`${API_BASE_URL}/patch-user-by-id/${currentUserId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        document.getElementById("addressModal").classList.add("hidden");
        loadUserData();
        alert("Address saved successfully!");
      } catch (err) {
        alert("Failed to save address");
      }
    }

    window.deleteAddress = async function() {
      if (!confirm("Delete this address permanently?")) return;
      try {
        await fetch(`${API_BASE_URL}/patch-user-by-id/${currentUserId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            addressLandmark: "", addressArea: "", addressCity: "", addressPincode: "",
            addressState: "", addressCountry: "", addressType: ""
          })
        });
        loadUserData();
        alert("Address deleted!");
      } catch (err) {
        alert("Delete failed");
      }
    };

    async function handleDeleteAccount() {
      if (!confirm("Delete your account permanently? This cannot be undone!")) return;
      try {
        await fetch(`${API_BASE_URL}/delete-by-user-id/${currentUserId}`, { method: 'DELETE' });
        sessionStorage.clear();
        alert("Account deleted successfully");
        window.location.href = "/";
      } catch (err) {
        alert("Failed to delete account");
      }
    }

    async function handleLogout() {
  if (!confirm("Are you sure you want to logout?")) return;

  // Clear all session & user data
  sessionStorage.removeItem('userId');
  sessionStorage.removeItem('currentUser');
  localStorage.removeItem('loggedInUser');

  // Optional: Clear saved pincode on logout (keeps guest mode clean)
  localStorage.removeItem('savedPincode');
  localStorage.removeItem('savedLocation');

  alert("Logged out successfully!");
  window.location.href = "/index.html"; // Redirect to home
}
  </script>
</body>
</html>